<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/crvo/css/components/components.css">
    <link rel="stylesheet" href="/crvo/css/modal.css">
    <link rel="stylesheet" href="/crvo/css/landing-page.css">
    <title>CANCUN RESORT VACATION OFFERS</title>
</head>

<body>
    <video class="video-background" autoplay muted loop>
        <source src="/components/media/videos/landing-page-crvo.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="gradient-overlay"></div>

    <div class="content-section">
        <div class="content-text">
            <h5>See if you Qualify for our</h5>
            <h1>exclusive Resort</h1>
        </div>
    </div>

    <div class="modal-overlay show" id="modalOverlay">
        <div class="modal-container">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</body>

<script src="/js/spa-router.js"></script>
<script src="/crvo/js/countries.js"></script>
<script src="/crvo/js/step-navigation.js"></script>
<script src="/crvo/js/modal.js"></script>

    <script>
        document.body.classList.add('modal-open');

        const urlParams = new URLSearchParams(window.location.search);
        const initialStep = urlParams.get('step') || '1'; 

        async function loadStep(stepNumber) {
            try {
                const response = await fetch(`./step-${stepNumber}.html`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const content = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, 'text/html');
                const newBodyContent = doc.body.innerHTML;

                document.getElementById('modalContent').innerHTML = newBodyContent;

                document.querySelectorAll('[data-dynamic-script]').forEach(script => script.remove());

                doc.querySelectorAll('script').forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                        newScript.async = false;
                    } else if (oldScript.textContent) {
                        newScript.textContent = oldScript.textContent;
                    }
                    newScript.setAttribute('data-dynamic-script', 'true'); 
                    document.body.appendChild(newScript);
                });

                addMobileCloseButton(); 

                window.history.pushState(null, '', `?step=${stepNumber}`);

                if (window.modal && typeof window.modal.init === 'function') {
                    console.log(`Step ${stepNumber} loaded. Re-initializing modal elements.`);
                    window.modal.init(); 
                    window.modal.renderStepContent(); 
                } else {
                    console.warn("window.modal.init is not defined. Ensure modal.js is loaded and properly exports 'modal'.");
                }
                
                window.checkPreSelected();

            } catch (error) {
                console.error('Error loading step:', error);
                document.getElementById('modalContent').innerHTML = '<p>Error loading content</p>';
            }
        }

        function addMobileCloseButton() {
            const stepContainer = document.querySelector('.step-container'); 
            if (stepContainer) {
                const existingBtn = stepContainer.querySelector('.mobile-close-btn');
                if (existingBtn) existingBtn.remove();
                
                if (window.innerWidth <= 768) {
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'mobile-close-btn';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.onclick = closeModal;
                    stepContainer.appendChild(closeBtn);
                }
            }
        }

        function closeModal() {
            window.location.href = '/crvo/pages/landing-page.html'; 
        }
        loadStep(initialStep);
        
        window.addEventListener('resize', addMobileCloseButton);
        window.selectOption = function(optionNumber) {
            console.log('Option selected:', optionNumber);
            const options = document.querySelectorAll('.step-option-1, .step-option-2');
            options.forEach(option => option.classList.remove('selected', 'unselected')); 

            const selectedOptionElement = document.querySelector(`.step-option-${optionNumber}`);
            if (selectedOptionElement) {
                selectedOptionElement.classList.add('selected');
                if (window.modal) {
                    window.modal.selectedOption = (optionNumber === 1) ? 'accommodations' : 'all-inclusive';
                }
            }
            const otherOptionElement = document.querySelector(`.step-option-${optionNumber === 1 ? 2 : 1}`);
            if (otherOptionElement) {
                otherOptionElement.classList.add('unselected');
            }
        };

        window.checkPreSelected = function() {
            let preSelected = localStorage.getItem('preSelectedOption');
            if (preSelected) {
                const optionMap = {
                    'accommodations': 1,
                    'all-inclusive': 2
                };
                if (optionMap[preSelected]) {
                    window.selectOption(optionMap[preSelected]); 
                }
                localStorage.removeItem('preSelectedOption');
            }
        };
    </script>

</html>